<!DOCTYPE html>
<html lang="en-us">
<head>

  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="google-site-verification" content="8Fk09hZ5X7EG1sQBo-CO8Z22Z4WT5XbyAn9ywvu6-nU" />
  <meta property="og:title" content="Understanding MatFormer - Nested Transformers for elastic inference" />
  <meta property="og:description" content="Google recently released the Gemma 3n models — E4B and E2B. The models are packed with novel components and features from PLEs, ASR and AST, MobileNet-V5 for vision etc. But one of the more interesting parts in the announcement is that E2B isn’t just a smaller sibling trained separately (or distilled) like other family of models we have previously seen (7B, 11B, 70B etc) — it’s actually a sub-model within E4B. Even more intriguing, the release mentioned that it’s possible to “mix and match” layers between the two, depending on memory and compute constraints to create even more models of different sizes. How was such a modularity achieved? How are different sized models trained simultaneously?" />
  <meta property="og:image" content="https://github.com/bhavinjawade/bhavinjawade.github.io/blob/master/post/matformers/featured.png?raw=true" />
  <meta property="og:url" content="https://bhavinjawade.github.io/post/matformers/" />
    
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-3400148121105734",
      enable_page_level_ads: true
    });
  </script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3400148121105734",
          enable_page_level_ads: true
    });
  </script>

  <meta name="generator" content="Source Themes Academic 4.1.0">
  <meta name="generator" content="Hugo 0.69.2" />

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Bhavin Jawade">

  
  
  
    
  
  <meta name="description" content="Google recently released the Gemma 3n models — E4B and E2B. The models are packed with novel components and features from PLEs, ASR and AST, MobileNet-V5 for vision etc. But one of the more interesting parts in the announcement is that E2B isn’t just a smaller sibling trained separately (or distilled) like other family of models we have previously seen (7B, 11B, 70B etc) — it’s actually a sub-model within E4B. Even more intriguing, the release mentioned that it’s possible to “mix and match” layers between the two, depending on memory and compute constraints to create even more models of different sizes. How was such a modularity achieved? How are different sized models trained simultaneously?">

  
  <link rel="alternate" hreflang="en-us" href="https://www.bhavinjawade.github.io/post/matformers/">

  


  

  

  

  

  

  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.0/css/all.css" integrity="sha384-aOkxzJ5uQz7WBObEZcHvV5JvRW3TUc2rNPA7pe3AwnsUohiw1Vj2Rgx2KSOkF5+h" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Montserrat:400,700|Roboto:400,400italic,700|Roboto+Mono">
  

  <link rel="stylesheet" href="/styles.css">
  

  
  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-136674527-1', 'auto');
      
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  
  

  
  <link rel="alternate" href="https://www.bhavinjawade.github.io/index.xml" type="application/rss+xml" title="Bhavin Jawade">
  <link rel="feed" href="https://www.bhavinjawade.github.io/index.xml" type="application/rss+xml" title="Bhavin Jawade">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://www.bhavinjawade.github.io/post/matformers/">

  
  
  
  
    
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="Bhavin Jawade">
  <meta property="og:url" content="https://www.bhavinjawade.github.io/post/matformers/">
  <meta property="og:title" content="Understanding MatFormer - Nested Transformers for elastic inference | Bhavin Jawade">
  <meta property="og:description" content="Google recently released the Gemma 3n models — E4B and E2B. The models are packed with novel components and features from PLEs, ASR and AST, MobileNet-V5 for vision etc. But one of the more interesting parts in the announcement is that E2B isn’t just a smaller sibling trained separately (or distilled) like other family of models we have previously seen (7B, 11B, 70B etc) — it’s actually a sub-model within E4B. Even more intriguing, the release mentioned that it’s possible to “mix and match” layers between the two, depending on memory and compute constraints to create even more models of different sizes. How was such a modularity achieved? How are different sized models trained simultaneously?"><meta property="og:image" content="https://www.bhavinjawade.github.io/post/matformers/featured.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2025-07-13T00:00:00&#43;00:00">
  
  <meta property="article:modified_time" content="2025-07-13T00:00:00&#43;00:00">
  

  

  

  <title>Understanding MatFormer - Nested Transformers for elastic inference | Bhavin Jawade</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" >
  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" role="textbox" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">Bhavin Jawade</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav mr-auto">
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#posts">
            
            <span>Posts</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
            
          
        

        <li class="nav-item">
          <a class="nav-link" href="https://www.github.com/bhavinjawade" target="_blank" rel="noopener">
            
            <span>Projects</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#publications">
            
            <span>Publications</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#talks">
            
            <span>Talks</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/tutorial/">
            
            <span>Tutorials</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#contact">
            
            <span>Contact</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/author/admin/bhavinjawade_cv_feb2025.pdf">
            
            <span>Resume</span>
            
          </a>
        </li>

        
        

      
      </ul>
      <ul class="navbar-nav ml-auto">
      

        

        
        <li class="nav-item">
          <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
        </li>
        

        

        
        <li class="nav-item">
          <a class="nav-link js-dark-toggle" href="#"><i class="fas fa-moon" aria-hidden="true"></i></a>
        </li>
        

      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  













<div class="article-header d-xl-none">
  <div class="featured-image" style="background-image: url('/post/matformers/featured_hua967663d745643d8a2d496a3ec56eb9f_405344_800x0_resize_lanczos_2.png');"></div>
  
</div>


<div class="container-fluid split-header d-none d-xl-block">
  <div class="row">
    <div class="col-6">
      <div class="split-header-content">
        <h1 itemprop="name">Understanding MatFormer - Nested Transformers for elastic inference</h1>

        
        <p class="page-subtitle">Matryoshka Styled Nested Transformers For Compute Efficient Inference — MatFormer used in Gemma 3n</p>
        

        



<meta content="2025-07-13 00:00:00 &#43;0000 UTC" itemprop="datePublished">
<meta content="2025-07-13 00:00:00 &#43;0000 UTC" itemprop="dateModified">

<div class="article-metadata">

  
  
  
  
  <div>
    



  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
      <span itemprop="name">
        

      
      
      <a href="">Bhavin Jawade</a></span></span>
  



  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    <time>Jul 13, 2025</time>
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    11 min read
  </span>
  

  
  
  <span class="middot-divider"></span>
  <a href="/post/matformers/#disqus_thread"></a>
  

  

  

</div>


        







  










        
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Understanding%20MatFormer%20-%20Nested%20Transformers%20for%20elastic%20inference&amp;url=https%3a%2f%2fwww.bhavinjawade.github.io%2fpost%2fmatformers%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.bhavinjawade.github.io%2fpost%2fmatformers%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.bhavinjawade.github.io%2fpost%2fmatformers%2f&amp;title=Understanding%20MatFormer%20-%20Nested%20Transformers%20for%20elastic%20inference"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fwww.bhavinjawade.github.io%2fpost%2fmatformers%2f&amp;title=Understanding%20MatFormer%20-%20Nested%20Transformers%20for%20elastic%20inference"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Understanding%20MatFormer%20-%20Nested%20Transformers%20for%20elastic%20inference&amp;body=https%3a%2f%2fwww.bhavinjawade.github.io%2fpost%2fmatformers%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


      </div>
    </div>
    <div class="col-6">
      <div class="split-header-image">
        <img src="/post/matformers/featured_hua967663d745643d8a2d496a3ec56eb9f_405344_680x500_fill_q90_lanczos_smart1_2.png" itemprop="image" alt="">
        
      </div>
    </div>
  </div>
</div>

<div class="article-container d-xl-none">
  <h1 itemprop="name">Understanding MatFormer - Nested Transformers for elastic inference</h1>

  
  <p class="page-subtitle">Matryoshka Styled Nested Transformers For Compute Efficient Inference — MatFormer used in Gemma 3n</p>
  

  



<meta content="2025-07-13 00:00:00 &#43;0000 UTC" itemprop="datePublished">
<meta content="2025-07-13 00:00:00 &#43;0000 UTC" itemprop="dateModified">

<div class="article-metadata">

  
  
  
  
  <div>
    



  <span itemscope itemprop="author" itemtype="http://schema.org/Person">
      <span itemprop="name">
        

      
      
      <a href="">Bhavin Jawade</a></span></span>
  



  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    <time>Jul 13, 2025</time>
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    11 min read
  </span>
  

  
  
  <span class="middot-divider"></span>
  <a href="/post/matformers/#disqus_thread"></a>
  

  

  
    
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Understanding%20MatFormer%20-%20Nested%20Transformers%20for%20elastic%20inference&amp;url=https%3a%2f%2fwww.bhavinjawade.github.io%2fpost%2fmatformers%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.bhavinjawade.github.io%2fpost%2fmatformers%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.bhavinjawade.github.io%2fpost%2fmatformers%2f&amp;title=Understanding%20MatFormer%20-%20Nested%20Transformers%20for%20elastic%20inference"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fwww.bhavinjawade.github.io%2fpost%2fmatformers%2f&amp;title=Understanding%20MatFormer%20-%20Nested%20Transformers%20for%20elastic%20inference"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Understanding%20MatFormer%20-%20Nested%20Transformers%20for%20elastic%20inference&amp;body=https%3a%2f%2fwww.bhavinjawade.github.io%2fpost%2fmatformers%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>

  







  









</div>



  <div class="article-container">

    <div class="article-style" itemprop="articleBody">
      <p>Google recently released the Gemma 3n models — E4B and E2B. The models are packed with novel components and features from PLEs, ASR and AST, MobileNet-V5 for vision etc. But one of the more interesting parts in the announcement is that E2B isn’t just a smaller sibling trained separately (or distilled) like other family of models we have previously seen (7B, 11B, 70B etc) — it’s actually a sub-model within E4B. Even more intriguing, the release mentioned that it’s possible to “mix and match” layers between the two, depending on memory and compute constraints to create even more models of different sizes. How was such a modularity achieved? How are different sized models trained simultaneously?</p>
<p>It turns out Gemma 3n uses an architecture called <a href="https://arxiv.org/pdf/2310.07707">MatFormer</a> — short for Matryoshka Transformer — (DeepMind, NeurIPS 2024). The idea is surprisingly elegant: train a larger model (E4B) in such a way that smaller, fully functional sub-models (like E2B) are embedded inside it. Like nested Matryoshka dolls, except here, it’s transformer layers. No distillation. No retraining. No routing like mixture of experts. Just shared weights and slicing while still preserving effective accuracy.</p>
<p>In this post, we’ll go deep into how MatFormer works — what parts of the architecture are shared, how sub-models are extracted, what makes the training objective feasible, and why this changes how we think about model scaling and deployment, especially for constrained environments.</p>
<figure>
  <img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LpakVBVcVI-Tjye2.jpg" alt="MatFormer architecture">
  <center>
  <figcaption>Image taken from Gemma 3n Developer Guide</figcaption>
  </center>
</figure>
<h2 id="matformer--matryoshka-transformer">MatFormer — Matryoshka Transformer</h2>
<p>A standard transformer layer consists of two learnable blocks — projections matrices in the Multi-head self-attention and the Feed-forward network (FFN). Feed-forward networks (FFNs) are the dominant contributors to both the parameter count and inference latency, and Matformer papers presents most of its experiments by applying the proposed nested architecture to FFN block (though it can be applied to any learnable weight).</p>
<p>In large-scale language models like Llama 3 and Gemma 3, the Feed-Forward Network (FFN) within each transformer block is typically implemented as a two-layer MLP (<a href="https://uxlfoundation.github.io/oneDNN/dev_guide_graph_gated_mlp.html">Gated MLP</a>):</p>
<ul>
<li>First Linear Layer (Expansion/Intermediate): Projects the input embedding to a higher-dimensional hidden space.</li>
<li>Activation Function: Often uses GELU, ReLU, or more recently, gated variants like SwiGLU or SiLU.</li>
<li>Second Linear Layer (Projection): Projects the hidden representation back to the original embedding dimension</li>
</ul>
<figure>
  <img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hyPl1WQfEC6fOF7u2U88rQ.png" alt="MatFormer architecture">
   <center>
  <figcaption>Transformer's FFN feedforward equation</figcaption>
  </center>
</figure>
<p>Here $d$ is token embedding dimension (model dimension). $d_{ff}$ is the Feed-forward hidden dimension. It’s the size of the intermediate activation in the FFN (feed-forward network) block. It’s typically much larger than $d$ ($d$ &raquo; $d_{ff}$), usually 4x–6x as large. For example, in a LLaMA-style transformer with $d$ = 4096, FFN often uses $d_{ff}$ = 11008 or more. These layers dominate model size and memory usage.</p>
<h3 id="nested-multiple-ffn-widths-from-one-ffn">Nested multiple FFN widths from one FFN:</h3>
<p>Instead of fixing a single FFN width per layer, MatFormer nests multiple FFNs of different widths inside each transformer block.</p>
<p>Let $d_{ff}$ be the largest FFN width we want to support (e.g. 16384), then sub-models with FFN width m_i​ simply use the top-left submatrix of the full weight matrices.</p>
<p>For example, let’s say $d$ = 4096 (input token dimension) and d_ff = 16384 (full FFN hidden dimension) and we choose a set of granularities we want to train for: m1 = 4096, m2 = 8192, m3 = 12288 and m4 = 16384. Here the idea is that submodules of smaller widths are subsets of those with larger widths.</p>
<figure>
  <img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hv4usoAZx2mVHgG-Moxsmw.png" alt="MatFormer architecture">
</figure>
<h3 id="training-all-granularities-jointly">Training All Granularities Jointly</h3>
<p>The next question is: how do we make sure all sub-models perform well? Rather than jointly computing the loss across all submodels in each training step, MatFormer adopts a more efficient approach: stochastic sampling of submodel granularities during training.</p>
<p>MatFormer uses a multi-granularity loss, computed as:</p>
<figure>
  <img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d200-fuUVyhfFr0a3uCIDQ.png" alt="MatFormer architecture">
</figure>
<p>$M_i$​ is the submodel corresponding to the i-th granularity (i.e., using only the first $m_i$ neurons in each FFN).</p>
<p>This design has two critical benefits. Only one submodel is evaluated per step, avoiding the overhead of computing all granularities simultaneously. Additionally, since each submodel shares parameters with the larger model, training a different one in each step still updates the shared weight matrices.</p>
<p>In the paper they uniformly sample each submodel with equal probability while computing this loss.</p>
<blockquote>
<p>In the experiments in appendix of the matformer, authors experiment with tuning the sampling probabilities for individual granularities. They find that upweight the loss for the largest granularity gives boost to the performance of bigger models while modest degradation to the performance of the smaller submodels.</p>
</blockquote>
<h3 id="way-more-number-of-accurate-smaller-models-for-free-mixnmatch">Way more number of accurate smaller models for free (Mix’n’Match)</h3>
<p>One of the most interesting aspects of MatFormer is that it doesn’t just give you g (number of trained) nested submodels — it gives you hundreds of submodels for free at inference time via a simple technique called Mix’n’Match.</p>
<p>During training, MatFormer explicitly optimizes $g$ submodels, each corresponding to a specific granularity (i.e., FFN width) across all layers. For example, one submodel might use width $m_1$​ (e.g., 4096) in all layers, another might use $m_3$​ (e.g., 12288) everywhere. But this doesn’t restrict us to uniform widths during inference.</p>
<p>At inference time, we can vary the FFN width layer by layer — one layer could use $m_2$​, the next $m_3$​, the next $m_2$ again, and so on. Since all the FFN blocks are nested, these hybrid models require no retraining, no fine-tuning, and no architectural redefinition.</p>
<p>This layer-wise configuration space is huge — for L layers and g granularities, there are g to the power L possible submodels. Even for small values (e.g., 32 layers, 4 granularities), that’s billions of options.</p>
<p>But not all of these perform equally well. To select a good configuration, the authors propose a simple heuristic:</p>
<blockquote>
<p>Prefer submodels where FFN widths vary slowly and consistently across layers.</p>
</blockquote>
<p>In other words: Avoid large jumps between small and large granularities from one layer to the next.</p>
<blockquote>
<p>Also, favor monotonic or gently increasing sequences — e.g., use m_2​ for early layers and gradually grow to m_3​ in later layers.</p>
</blockquote>
<p>this heuristic aligns well with how the model was trained — where sampled submodels always used uniform widths per step. So while hybrid layer-wise combinations were never explicitly trained, configurations that look similar to the training regime generalize better.</p>
<figure>
  <img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3TSq3Erd69_FiyVvbFNhnQ.png" alt="MatFormer architecture">
</figure>
<p>The authors of Matformer applied this approach to two transformer based models — LLMs and ViTs (called MatLM and MatViT respectively)</p>
<p>For LLMs trained with Matformer’s nested FFN, the authors find that all granularity submodels of Matformer outperform their respective separately or independently trained similar sized vanilla transformers LLMs. In above the experiments for MatLM, they trained 4 nested granularities with $d_{ffn}$ (FFN dimension) / $d$ (model dimension) ratios of → {0.5, 1, 2, 4}. They named respective models as S, M, L and XL. Here XL is the full model.</p>
<blockquote>
<p>Even though in the matformer paper the maximum size transformer trained was 850M parameters, Gemma 3n utilizing matformer for 4B (effective 5B) shows parametric scalability of this approach.</p>
</blockquote>
<h3 id="performance-of-mixnmatch-models">Performance of Mix’n’Match models</h3>
<p>They also observed that Mix’n’Match models tend to lie on the accuracy-to-compute trade-off curve (Pareto-optimal accuracy-vs-model-size). Which means that based on the available compute resources, the biggest possible Mix’n’Match model can be created during inference, which showed likely have better accuracy then relatively smaller trained submodel. This has interesting implications. For instance, many a times in deployment use-cases we have enough compute resources (GPU memory) to load a 20B parameter model, but the nearest variant that is available to us is either a 14B or 33B. Using the 14B parameter models leads to underutilization of resources and subpar performance and the 33B parameter model won’t fit in memory. This Mix’n’match approach allows to create nearly perfect sized variants for free with commensurate accuracy trade-off.</p>
<blockquote>
<p>Gemma 3n being based on the Matformer architecture also gives us the liberty to perform Mix’n’Match and create many more model sizes between 2B and 4B. In terms of the performance, Gemma 3n E4B has MMLU accuracy of 62.3%, and E2B has 50.90%. Mix’n’Match ‘ed variants such as 2.54B has MMLU accuracy of 55.40% and 2.69B has 57.70%, which significantly better than 2B and little lower than 4B. This allows us to get perfectly sized accurate model for on-device deployment usecase — smartphone, tab, mac, etc.</p>
</blockquote>
<p>To try out creating mix’n’match variants of the Gemma 3n model, Gemma 3n team has released <a href="https://colab.research.google.com/github/google-gemini/gemma-cookbook/blob/main/Gemma/%5BGemma_3n%5DMatFormer_Lab.ipynb#scrollTo=dOG0dm7LHmBE">Matformer Lab, which is colab notebook</a> where you can slice the model and push it to huggingface. They have also released some optimal slicing configurations (as we saw above though we can generated g to the power L models, not all mix’n’matches might be optimal for desired size) on hugging face — <a href="https://huggingface.co/datasets/google/gemma3n-slicing-configs">google/gemma3n-slicing-configs</a>. These configurations include varying the FFN dimension at either layer level, which is more finegrained or at block level which includes 4 local layers and 1 global layer.</p>
<figure>
  <img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q-bijVh45HaDJxk0YrOXnQ.png" alt="MatFormer architecture">
  <center>
  <figcaption>Image taken from Matformer paper — https://arxiv.org/pdf/2310.07707</figcaption>
  </center>
</figure>
<p>Another aspect of training smaller models as nested submodels of the bigger model that authors focus on is consistency of predicted tokens. One way verifying this consistency is by looking at rejection rates of <a href="https://arxiv.org/pdf/2211.17192">speculative decoding</a>. In speculative decoding, instead of always autoregressively predicting the tokens from the large target model, there is a smaller “Draft model” and a larger “Verifier model” (target model). The draft model performs token speculation, i.e. it predicts the next n tokens along with their probabilities, and the target model parrallely performs verification of the predicted tokens. Comparing the target model’s probabilities for the same tokens predicted by the draft model rejection sampling is performed. When the draft models is significantly off with respect to the target model, the draft model’s predictions are rejected. As one could see, here the most significant speed-ups come when the draft model consistently predicts the similar token distribution as the target model, leading to lesser rejections. If rejections would be more, then we won’t get the desired inference speed ups expected from speculative decoding. Authors of Matformer, show that since the smaller submodels are nested within and are trained along side the larger (XL) model they show more consistent nature required for drafter and verifier models. When traditional speculative decoding using a independently trained “S” sized model with XL model as target led to 10% inference speed time speedup over autoregressive decoding of target model, using the “S” sized MatLM model led to 16% speedup.</p>
<p>Moreover since the two MatLM models (S and XL) are trained together, it allows for shared attention caches (this cannot be done with indepedently trained models since the latent reps would be very different).</p>
<blockquote>
<p>What I find even more interesting is that during deployment, the universal XL model can be stored in memory and based on the compute constraints be used to extract an adaptable smaller model. This dynamic resource adaptive model extraction and inference might be really useful for edge use-cases.</p>
</blockquote>
<h3 id="the-case-for-image-retrieval">The Case for Image Retrieval</h3>
<p>Authors also trained the Matformer for ViTs (Vision transformers) encoders (MatViT). Apart from similar trends as observed for MatLM, an interesting use-case of MatViT is in fast image retrieval. In typical image retriveal, getting embeddings for gallery images (gallery creation) happens offline and are stored, while quering (creating embedding for the query image) happens real-time. This means that gallery embeddings can utilize bigger more accurate models, while the query embeddings might require a smaller model for fast inference. Since smaller submodels in Matformers are nested and trained jointly, they tend to share the same embedding space as the bigger model and lead to meaningful distances for nearest neighbour based retrieval. This allows for using the XL model for gallery encoding, while using a smaller (ex: S) model for querying.</p>
<figure>
  <img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZsdF-ZNGn6Or0GrCkQqm6Q.png" alt="MatFormer architecture">
  <center>
  <figcaption>Image taken from the original Matformer paper</figcaption>
  </center>
</figure>
<h3 id="how-are-matformers-different-from-moes">How are MatFormers different from MoEs?</h3>
<p>Almost all major recent open LLM transformers are MoE architectures. <a href="https://arxiv.org/abs/1701.06538">Mixture of Experts (MoE)</a> models increase capacity by adding multiple FFNs — called experts — to each transformer layer. At inference time, a router decides which expert(s) to use for each token, and only those selected paths are executed. This reduces compute cost per forward pass, since most experts stay inactive. However, all expert weights still need to be loaded into memory, because the router can choose any of them at runtime. This makes MoE models difficult to deploy on memory-constrained devices — while compute is sparse, memory usage stays high. In contrast, MatFormer doesn’t rely on routing or multiple experts. Instead, each FFN is designed to support multiple granularities by nesting smaller sub-networks inside larger ones. At inference time, a specific submodel can be selected and run independently. Only the parameters for that submodel need to be loaded into memory. This makes MatFormer much better suited for on-device or low-memory inference, where storing the full model isn’t feasible.</p>
<h2 id="conclusion">Conclusion</h2>
<p>MatFormer represents a significant shift in how we approach model training, inference, and deployment. Traditionally, large models are trained with massive compute budgets, and smaller variants are created afterward — either trained separately or distilled from the larger ones. MatFormer breaks from this pattern by nesting multiple functional submodels within a single transformer via shared weight training, eliminating the need for costly distillation, retraining, or complex routing like Mixture-of-Experts. This design unlocks a smooth continuum of resource-adaptive models — from lightweight, mobile-ready deployments to full-capacity inference engines — all derived from a single base model. The success of Gemma 3n’s E2B and E4B, the versatility of Mix’n’Match variants, and the cross-modal generalizability demonstrated by MatViT encoders suggest that MatFormer-style architectures could become the new default for how research labs release scalable model families.</p>
<h2 id="resources">Resources</h2>
<ul>
<li>Matformer: Devvrit, Fnu, et al. “Matformer: Nested transformer for elastic inference.” Advances in Neural Information Processing Systems 37 (2024): 140535–140564. <a href="https://arxiv.org/abs/2310.07707">https://arxiv.org/abs/2310.07707</a></li>
<li>Speculative Decoding: Leviathan, Yaniv, Matan Kalman, and Yossi Matias. “Fast inference from transformers via speculative decoding.” ICML, PMLR, 2023 <a href="https://arxiv.org/pdf/2211.17192">https://arxiv.org/pdf/2211.17192</a></li>
<li>NeurIPS 2023 video and slides: <a href="https://neurips.cc/virtual/2023/80908">https://neurips.cc/virtual/2023/80908</a></li>
<li>Gemma 3n Developer Guide: <a href="https://developers.googleblog.com/en/introducing-gemma-3n-developer-guide/">https://developers.googleblog.com/en/introducing-gemma-3n-developer-guide/</a></li>
<li>Hugging Face Blog: <a href="https://huggingface.co/blog/gemma3n">https://huggingface.co/blog/gemma3n</a></li>
<li>MatFormer Lab: [https://colab.research.google.com/github/google-gemini/gemma-cookbook/blob/main/Gemma/Gemma_3n]MatFormer_Lab.ipynb</li>
<li>Gemma 3 Technical Report: <a href="https://arxiv.org/pdf/2503.19786v1">https://arxiv.org/pdf/2503.19786v1</a></li>
</ul>
<p><em>Footnote on Gemma 3 attention</em>: See Gemma 3 technical paper for details on global and local attention</p>
<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/eJFJRyXEHZ0?si=ttY_d02U_O6X_os_" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</center>
<p><em>Subscribe at the bottom of this page to get updated when a new article comes up!</em></p>

    </div>

    


<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/architecture/">Architecture</a>
  
  <a class="badge badge-light" href="">Machine Learning</a>
  
  <a class="badge badge-light" href="">Deep Learning</a>
  
  <a class="badge badge-light" href="/tags/llm/">LLM</a>
  
  <a class="badge badge-light" href="/tags/transformers/">Transformers</a>
  
  <a class="badge badge-light" href="/tags/ai/">AI</a>
  
</div>




    
      






  
  
    
  
  







      
      
      <div class="article-widget">
        <div class="hr-light"></div>
        <h3>Related</h3>
        <ul>
          
          <li><a href="/post/orpo/">ORPO — Preference Optimization without Reference Model</a></li>
          
          <li><a href="/post/selfextend/">Tuning-Free Longer Context Lengths For LLMs — A Review of Self-Extend (LLM Maybe LongLM)</a></li>
          
          <li><a href="/post/gqa/">Demystifying GQA — Grouped Query Attention for Efficient LLM Pre-training</a></li>
          
          <li><a href="/post/lora/">Understanding LoRA — Low Rank Adaptation For Finetuning Large Models</a></li>
          
          <li><a href="/post/avrotf/">Linkedin opensources Avro2TF</a></li>
          
        </ul>
      </div>
      
    

    

    
<section id="comments">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "bhavinjawade-me" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <form style="text-align: center;" id="formid" method="GET" enctype="application/x-www-form-urlencoded" action = "https://docs.google.com/forms/d/e/1FAIpQLScIS1hIVJyfo1iprQSLmZfKTj9zugkv7X2Ce6kOBaT1F4KChQ/formResponse">
        <input type = "hidden" name="entry.1639441032" id="firstname" value = "User"/>
        <input type = "hidden" name="entry.1590194600" id="lastname" value = ""/>
        <input name="entry.525161483" required placeholder="email address" id="email" type="email" style="width: 60%;outline: none;font-size: 18px;padding: 1%;font-weight: 500;color: #6d6d6d;border-radius: 29px;padding-left: 3%;padding-right: 3%;border: none;border: 1px solid #e2e2e2;border-top-right-radius: 0;border-bottom-right-radius: 0;"/>
        <input type="submit" name = "submit" value="Subscribe" style="margin-left: -5px;background-color: #58baff;border: none;border: 1px solid #58baf8;border-radius: 20px;padding: 1%;padding-left: 3%;padding-right: 3%;border-radius: 29px;font-size: 18px;color: white;cursor: pointer;border-top-left-radius: 0;border-bottom-left-radius: 0;"/>
    </form>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://malsup.github.com/jquery.form.js"></script> 
    <script type='text/javascript'>
         
        $(document).ready(function() { 
                
                $('#formid').ajaxForm(function() { 
                    alert("Thank you for your comment!"); 
                });
            }); 
    </script>
  <br>
  <p class="powered-by">
    

    Copyright
    <a href="https://www.linkedin.com/in/bhavinjawade" target="_blank" rel="noopener">Bhavin Jawade</a> | 2018-2019 |  
    <a href="mailto:bhavinjawade@gmail.com" target="_blank" rel="noopener">bhavinjawade@gmail.com</a>.
    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
  
<script type="text/javascript">
    var vglnk = {key: '42643b2b96638249d923f00eda66c144'};
    (function(d, t) {
        var s = d.createElement(t);
            s.type = 'text/javascript';
            s.async = true;
            s.src = '//cdn.viglink.com/api/vglnk.js';
        var r = d.getElementsByTagName(t)[0];
            r.parentNode.insertBefore(s, r);
    }(document, 'script'));
</script>

</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
      

      
      
    

    
    

    
    
    
    <script id="dsq-count-scr" src="//bhavinjawade-me.disqus.com/count.js" async></script>
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "results found",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.1846cc5c27f3006b56814095ec02281f.js"></script>

  </body>
</html>

